<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ph√°o Hoa AI T·∫øt 2026 - Full Hi·ªáu ·ª®ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        #canvas-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
        }
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }
        .input_video { display: none; }

        /* =========================================
           1. OVERLAY GI·ªÆA M√ÄN H√åNH (C≈®)
           ========================================= */
        #overlay-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 6; /* Cao nh·∫•t */
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #overlay-img {
            max-width: 80%;
            max-height: 50%;
            object-fit: contain;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* =========================================
           2. DIV CH·∫†Y NGANG (M·ªöI)
           ========================================= */
        #flying-layer {
            position: absolute;
            bottom: 5%;
            left: 0;
            width: 100%;
            height: 150px; /* Chi·ªÅu cao v√πng ch·∫°y */
            pointer-events: none;
            z-index: 5; /* D∆∞·ªõi overlay gi·ªØa nh∆∞ng tr√™n ph√°o */
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            overflow: hidden;
        }

        #flying-obj {
            height: 100%; /* Cao b·∫±ng container */
            width: auto;
            position: absolute;
            /* Animation ch·∫°y ngang */
            animation: runAcross 15s linear infinite; 
        }

        @keyframes runAcross {
            from { transform: translateX(-100vw); } /* B·∫Øt ƒë·∫ßu t·ª´ ngo√†i b√™n tr√°i */
            to { transform: translateX(100vw); }    /* Ch·∫°y sang ngo√†i b√™n ph·∫£i */
        }

        /* UI Status */
        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 50px;
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ffd700;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
            display: none;
            white-space: nowrap;
        }
        #energy-bar-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 300px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            z-index: 11;
            display: none;
        }
        #energy-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00);
            transition: width 0.1s;
        }

        /* Intro Screen */
        #intro-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }
        h1 { color: #ffd700; margin-bottom: 10px; text-align: center; font-size: 1.8rem; }
        .subtitle { color: #ffcc00; font-size: 1rem; margin-bottom: 30px; text-align: center; opacity: 0.8; }
        #start-btn {
            width: 80%; max-width: 300px; padding: 18px; border: none; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; color: white; background: #d63031;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.4); text-transform: uppercase;
        }
        .info-text { color: #888; font-size: 0.85rem; margin-top: 20px; text-align: center; line-height: 1.5; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="intro-screen">
        <h1>üéÜ PH√ÅO HOA T·∫æT 2026</h1>
        <p class="subtitle">‚ú® Full Hi·ªáu ·ª®ng ‚ú®</p>
        <button id="start-btn">B·∫ÆT ƒê·∫¶U</button>
        <p class="info-text">N·∫Øm tay ƒë·ªÉ k√≠ch ho·∫°t ph√°o hoa<br>C·∫©n th·∫≠n coi ch·ª´ng nghi·ªán!</p>
    </div>

    <div id="status">Kh·ªüi ƒë·ªông...</div>
    <div id="energy-bar-container"><div id="energy-bar"></div></div>
    
    <div id="flying-layer">
        <img id="flying-obj" src="https://media.giphy.com/media/l4pTfx2qLszoacZRS/giphy.gif" alt="Flying Object">
    </div>

    <div id="overlay-layer">
        <img id="overlay-img" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExcDk5bnZ6b3Z6c3Z6c3Z6c3Z6c3Z6c3Z6c3Z6c3Z6c3Z6/3o6fJcIM6mG3Ad6lAk/giphy.gif" alt="Happy New Year">
    </div>

    <div id="canvas-container">
        <video class="input_video" playsinline muted></video>
        <canvas id="output_canvas"></canvas>
    </div>

<script>
    // ==========================================================
    // C·∫§U H√åNH
    // ==========================================================
    const CONFIG = {
        backgroundMusic: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        explosionSound: "https://freesound.org/data/previews/156/156031_270351-lq.mp3",
        durationSeconds: 90
    };

    function playExplosion() {
        if (Math.random() > 0.3) return; 
        if (CONFIG.explosionSound) {
            const audio = new Audio(CONFIG.explosionSound);
            audio.volume = 0.2;
            audio.play().catch(e => {});
        }
    }

    let bgMusic = new Audio(CONFIG.backgroundMusic);
    bgMusic.loop = true;
    bgMusic.volume = 0.4;

    const COLORS = ['#FF3D00', '#FFEA00', '#00E676', '#2979FF', '#D500F9', '#FFFFFF'];
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
    let width, height;

    let stars = [];
    let rockets = [];
    let particles = [];
    let handState = 'OPEN';
    let energy = 0;
    let isExploding = false;
    let explosionTimer = 0;
    let lastRocketTime = 0;

    // --- CLASS LOGIC (R√∫t g·ªçn) ---
    class Star {
        constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.size = Math.random() * 1.2; this.alpha = Math.random(); this.speed = Math.random() * 0.05; }
        update() { this.alpha += this.speed; if (this.alpha > 1 || this.alpha < 0) this.speed = -this.speed; }
        draw() { ctx.fillStyle = '#FFFFFF'; ctx.globalAlpha = Math.abs(this.alpha) * 0.6; ctx.fillRect(this.x, this.y, this.size, this.size); }
    }

    class Rocket {
        constructor(delay = 0) {
            this.x = Math.random() * width * 0.8 + width * 0.1; this.y = height;
            this.targetY = height * 0.15 + Math.random() * height * 0.25;
            this.speed = 12 + Math.random() * 6; this.angle = -Math.PI / 2 + (Math.random() - 0.5) * 0.2;
            this.color = COLORS[Math.floor(Math.random() * COLORS.length)];
            this.trail = []; this.dead = false; this.delay = delay; this.active = delay === 0;
        }
        update() {
            if (this.delay > 0) { this.delay--; return; } this.active = true;
            this.trail.push({x: this.x, y: this.y}); if (this.trail.length > 5) this.trail.shift();
            this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed;
            this.speed *= 0.98; if (this.y <= this.targetY || this.speed < 2) { this.dead = true; this.explode(); }
        }
        draw() {
            if (!this.active) return;
            if (this.trail.length > 1) {
                ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 2;
                ctx.moveTo(this.trail[0].x, this.trail[0].y); for(let i=1; i<this.trail.length; i++) ctx.lineTo(this.trail[i].x, this.trail[i].y); ctx.stroke();
            }
            ctx.fillStyle = this.color; ctx.fillRect(this.x - 2, this.y - 2, 4, 4);
        }
        explode() {
            playExplosion();
            const particleCount = 40 + Math.floor(Math.random() * 20);
            for (let i = 0; i < particleCount; i++) particles.push(new Particle(this.x, this.y, this.color));
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 6 + 2;
            this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
            this.life = 1.0; this.decay = 0.015 + Math.random() * 0.015;
            this.gravity = 0.08; this.size = 2 + Math.random() * 2;
        }
        update() { this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.vx *= 0.95; this.vy *= 0.95; this.life -= this.decay; }
        draw() { if (this.life <= 0) return; ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); }
    }

    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    function initGame() { stars = []; for (let i = 0; i < 100; i++) stars.push(new Star()); }

    function animate() {
        ctx.globalCompositeOperation = 'source-over'; ctx.fillStyle = 'rgba(0, 0, 0, 0.25)'; ctx.fillRect(0, 0, width, height);
        stars.forEach(s => { s.update(); s.draw(); });

        if (isExploding) {
            const now = Date.now();
            if (now - lastRocketTime > 400) {
                const count = 3 + Math.floor(Math.random() * 3);
                for (let i = 0; i < count; i++) rockets.push(new Rocket(i * 2));
                lastRocketTime = now;
            }
            if (now > explosionTimer) resetGame();
        }

        ctx.globalCompositeOperation = 'lighter';
        for (let i = rockets.length - 1; i >= 0; i--) { rockets[i].update(); rockets[i].draw(); if (rockets[i].dead) rockets.splice(i, 1); }
        for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); particles[i].draw(); if (particles[i].life <= 0) particles.splice(i, 1); }
        
        ctx.globalCompositeOperation = 'source-over';
        document.getElementById('energy-bar').style.width = Math.min(energy, 100) + '%';
        requestAnimationFrame(animate);
    }

    // --- QU·∫¢N L√ù TR·∫†NG TH√ÅI HI·ªÜN/·∫®N ---
    function resetGame() {
        isExploding = false;
        bgMusic.pause(); bgMusic.currentTime = 0;
        document.getElementById('status').innerText = "üëä N·∫Øm tay ƒë·ªÉ ch∆°i l·∫°i!";
        energy = 0; rockets = []; particles = [];
        
        // ·∫®n c·∫£ 2 l·ªõp h√¨nh ·∫£nh
        document.getElementById('overlay-layer').style.display = 'none';
        document.getElementById('flying-layer').style.display = 'none';
    }

    const introScreen = document.getElementById('intro-screen');
    const statusText = document.getElementById('status');
    const energyContainer = document.getElementById('energy-bar-container');

    document.getElementById('start-btn').addEventListener('click', () => {
        introScreen.style.display = 'none';
        statusText.style.display = 'block';
        energyContainer.style.display = 'block';
        statusText.innerText = "üì∑ ƒêang m·ªü Camera...";
        if (bgMusic) bgMusic.load();
        initGame(); startCamera(); animate();
    });

    // --- AI HAND TRACKING ---
    const videoElement = document.getElementsByClassName('input_video')[0];
    function onResults(results) {
        if (isExploding) return;
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const dist = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            if (dist < 0.1) {
                handState = 'CLOSED'; energy += 3.5;
                statusText.innerText = "‚ö° T√≠ch t·ª•: " + Math.floor(energy) + "%";
                if (energy > 100) energy = 100;
            } else {
                handState = 'OPEN';
                if (energy > 90) {
                    isExploding = true;
                    explosionTimer = Date.now() + (CONFIG.durationSeconds * 1000);
                    statusText.innerText = "üéÜ CH√öC M·ª™NG NƒÇM M·ªöI 2026! üéÜ";
                    lastRocketTime = Date.now() - 2000;
                    bgMusic.play().catch(e => {});
                    for (let i = 0; i < 8; i++) rockets.push(new Rocket(i * 3));
                    
                    // HI·ªÜN C·∫¢ 2 L·ªöP H√åNH ·∫¢NH KHI N·ªî
                    document.getElementById('overlay-layer').style.display = 'flex';
                    document.getElementById('flying-layer').style.display = 'block';
                    
                } else if (energy > 0) {
                    energy -= 4; statusText.innerText = "üí™ N·∫Øm ch·∫∑t tay l·∫°i!";
                }
            }
        } else {
            handState = 'OPEN'; if (energy > 0) energy -= 2;
        }
    }

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    async function startCamera() {
        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 480, height: 360
        });
        await camera.start();
        statusText.innerText = "üëä N·∫Øm tay l·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu!";
    }
</script>
</body>
</html>