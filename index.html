<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tet Holiday Magic Fireworks (Optimized)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #1a0000;
            background-image: radial-gradient(circle, #3a0000 0%, #000000 100%);
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh;
        }
        #canvas-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 2; }
        .input_video { display: none; }
        #status {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10; background: rgba(255, 0, 0, 0.3); padding: 8px 20px;
            border-radius: 50px; color: #ffd700; font-weight: bold;
            pointer-events: none; text-align: center; border: 2px solid #ffd700;
            font-size: 1rem; white-space: nowrap;
        }
        #energy-bar {
            position: absolute; bottom: 0; left: 0; height: 5px;
            background: #ffd700; width: 0%; z-index: 11;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="status">ƒêang kh·ªüi ƒë·ªông...</div>
    <div id="energy-bar"></div>
    <div id="canvas-container">
        <video class="input_video" playsinline muted></video>
        <button id="startCam" style="position:fixed; z-index:9999; top:50%; left:50%; transform:translate(-50%,-50%); padding:16px 28px; font-size:18px; border-radius:12px; border:none; background:#ff0000; color:#fff; box-shadow:0 0 20px rgba(255,0,0,.8);">üé• B·∫≠t camera (Mobile)</button>
        <canvas class="output_canvas"></canvas>
    </div>

<script>
    // --- C·∫§U H√åNH T·ªêI ∆ØU CHO MOBILE ---
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Gi·∫£m s·ªë l∆∞·ª£ng h·∫°t n·∫øu l√† mobile (t·ª´ 2500 xu·ªëng 600)
    const PARTICLE_COUNT = isMobile ? 600 : 1500; 
    const TET_COLORS = ['#ff0000', '#ff4d00', '#ffd700', '#ffa500', '#ffff00', '#ffffff'];
    const ANIMAL_COLORS = ['#00ffff', '#ff00ff', '#7fff00', '#00ff7f', '#ffd700'];

    const EXPLOSION_THRESHOLD = 100; 
    const CHARGE_SPEED = 2.0; // TƒÉng t·ªëc ƒë·ªô n·∫°p ƒë·ªÉ ƒë·ª° ph·∫£i n·∫Øm tay l√¢u
    const FIREWORK_DURATION = 60000;

    const canvas = document.querySelector('.output_canvas');
    const ctx = canvas.getContext('2d', { alpha: false }); // T·ªëi ∆∞u context
    const statusText = document.getElementById('status');
    const energyBar = document.getElementById('energy-bar');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particles = [];
    let specialRockets = [];
    let shapeParticles = [];
    let handState = 'OPEN';
    let compressionLevel = 0;   
    let isFireworkMode = false;
    let fireworkEndTime = 0;
    let lastRocketSpawn = 0;
    let rocketSpawnInterval = 800;

    // --- CLASS T·ªêI ∆ØU ---
    class Particle {
        constructor() { this.reset(); this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.tx = this.x; this.ty = this.y;
            this.vx = 0; this.vy = 0;
            this.color = TET_COLORS[Math.floor(Math.random() * TET_COLORS.length)];
            this.size = Math.random() * 2 + 1; // H·∫°t nh·ªè h∆°n x√≠u
            this.alpha = 1;
        }
        update() {
            if (isFireworkMode) {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.15; this.vx *= 0.96; this.vy *= 0.96;
                this.alpha -= 0.015; // Tan nhanh h∆°n ƒë·ªÉ gi·∫£m t·∫£i
                if (this.alpha <= 0 || this.y > canvas.height) this.reset();
            } else if (handState === 'CLOSED') {
                const centerX = canvas.width / 2; const centerY = canvas.height / 2;
                const strength = 0.08 + (compressionLevel / 150);
                this.x += (centerX - this.x) * strength;
                this.y += (centerY - this.y) * strength;
            } else {
                if (Math.abs(this.tx - this.x) < 10) {
                    this.tx = this.x + (Math.random() - 0.5) * 100;
                    this.ty = this.y + (Math.random() - 0.5) * 100;
                }
                this.x += (this.tx - this.x) * 0.05;
                this.y += (this.ty - this.y) * 0.05;
            }
        }
        draw() {
            // KH√îNG D√ôNG save/restore li√™n t·ª•c
            // KH√îNG D√ôNG shadowBlur tr√™n mobile
            ctx.beginPath();
            ctx.fillStyle = this.color;
            ctx.globalAlpha = isFireworkMode ? this.alpha : 1;
            ctx.rect(this.x, this.y, this.size, this.size); // V·∫Ω h√¨nh vu√¥ng nhanh h∆°n h√¨nh tr√≤n
            ctx.fill();
        }
    }

    // (Gi·ªØ nguy√™n logic Rocket nh∆∞ng b·ªè shadowBlur khi v·∫Ω)
    class SpecialRocket {
        constructor() {
            this.x = Math.random() * canvas.width * 0.8 + canvas.width * 0.1;
            this.y = canvas.height;
            this.targetY = canvas.height * 0.2 + Math.random() * canvas.height * 0.3;
            this.speed = 12 + Math.random() * 5;
            this.color = ANIMAL_COLORS[Math.floor(Math.random() * ANIMAL_COLORS.length)];
            this.dead = false;
        }
        update() {
            this.y -= this.speed;
            if (this.y <= this.targetY) { this.dead = true; this.triggerExplosion(); }
        }
        draw() {
            ctx.beginPath();
            ctx.fillStyle = this.color;
            ctx.globalAlpha = 1;
            ctx.rect(this.x, this.y, 4, 10); // V·∫Ω t√™n l·ª≠a ƒë∆°n gi·∫£n
            ctx.fill();
        }
        triggerExplosion() {
            createNormalExplosion(this.x, this.y, this.color);
        }
    }

    class ShapeParticle {
        constructor(x, y, color, vx, vy) {
            this.x = x; this.y = y; this.color = color;
            this.vx = vx; this.vy = vy;
            this.life = 60; this.alpha = 1;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.vy += 0.1; this.alpha -= 0.02; this.life--;
        }
        draw() {
            if (this.alpha <= 0) return;
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.rect(this.x, this.y, 3, 3);
            ctx.fill();
        }
    }

    function createNormalExplosion(x, y, color) {
        // Gi·∫£m s·ªë l∆∞·ª£ng h·∫°t n·ªï
        const count = isMobile ? 40 : 80;
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 6;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;
            shapeParticles.push(new ShapeParticle(x, y, color, vx, vy));
        }
    }

    for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Particle());

    function animate() {
        // X√≥a m√†n h√¨nh nhanh
        ctx.globalAlpha = 1;
        ctx.fillStyle = '#1a0000'; // X√≥a h·∫≥n m√†u n·ªÅn thay v√¨ v·∫Ω l·ªõp m·ªù (nhanh h∆°n)
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        particles.forEach(p => { p.update(); p.draw(); });

        if (isFireworkMode) {
            const now = Date.now();
            if (now - lastRocketSpawn > rocketSpawnInterval) {
                lastRocketSpawn = now;
                specialRockets.push(new SpecialRocket());
            }
            for (let i = specialRockets.length - 1; i >= 0; i--) {
                specialRockets[i].update(); specialRockets[i].draw();
                if (specialRockets[i].dead) specialRockets.splice(i, 1);
            }
            for (let i = shapeParticles.length - 1; i >= 0; i--) {
                shapeParticles[i].update(); shapeParticles[i].draw();
                if (shapeParticles[i].life <= 0) shapeParticles.splice(i, 1);
            }
        }
        
        // V·∫Ω l·∫°i thanh nƒÉng l∆∞·ª£ng
        if (!isFireworkMode) {
            energyBar.style.width = Math.min(compressionLevel, 100) + '%';
        } else {
            energyBar.style.width = '0%';
        }
        
        requestAnimationFrame(animate);
    }
    animate();

    // --- CAMERA SETUP CHO MOBILE (ƒê·ªô ph√¢n gi·∫£i th·∫•p) ---
    const videoElement = document.getElementsByClassName('input_video')[0];
    function onResults(results) {
        if (isFireworkMode) return;
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            const dist = Math.sqrt(Math.pow(landmarks[8].x - landmarks[0].x, 2) + Math.pow(landmarks[8].y - landmarks[0].y, 2));
            const isClosed = dist < 0.25;
            handState = isClosed ? 'CLOSED' : 'OPEN';
            if (handState === 'CLOSED') {
                compressionLevel += CHARGE_SPEED;
                statusText.innerText = "ƒêang n·∫°p...";
            } else if (compressionLevel > EXPLOSION_THRESHOLD) {
                isFireworkMode = true;
                fireworkEndTime = Date.now() + FIREWORK_DURATION;
                statusText.innerText = "CH√öC M·ª™NG NƒÇM M·ªöI!";
            }
        } else {
            handState = 'OPEN';
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // 0: Nhanh nh·∫•t (cho mobile), 1: Trung b√¨nh
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 480, // Gi·∫£m ƒë·ªô ph√¢n gi·∫£i xu·ªëng 480p ho·∫∑c 360p
        height: 360
    });

    document.getElementById("startCam").addEventListener("click", async function() {
        this.style.display = "none";
        statusText.innerText = "ƒêang m·ªü cam...";
        await camera.start();
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
</script>
</body>
</html>